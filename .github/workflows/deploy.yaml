name: Deploy Web & Admin to Vercel (manual-selectable)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "λ°°ν¬ν•  μ•± μ„ νƒ"
        required: true
        default: "all"
        type: choice
        options: [all, web, admin]

# β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ WEB β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
jobs:
  deploy-web:
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'web' }}
    runs-on: ubuntu-latest
    concurrency: web-prod
    env:
      APP_DIR:           ${{ github.workspace }}              # λ£¨νΈ κΈ°μ¤€
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      PROD_ALIAS:        "web.dddorok.vercel.app"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm@9
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install deps
        run: |
          echo "PWD: $(pwd)"
          pnpm install --frozen-lockfile

      # β”€β”€β”€ Pull & Build (prebuilt) β”€β”€β”€
      - name: Vercel Pull
        run: |
          echo "β†’ vercel pull"
          npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"

      - name: Vercel Build
        run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          echo "β–¶ Build output"
          ls -al .vercel/output

      # β”€β”€β”€ Deploy (prebuilt) β”€β”€β”€
      - name: Vercel Deploy
        id: deploy-web
        run: |
          echo "PWD: $(pwd)"
          ls -al .vercel/output || { echo "β .vercel/output not found"; exit 1; }
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "β–¶ Deployed β†’ $DEPLOY_URL"

      # β”€β”€β”€ Slack μ•λ¦Ό β”€β”€β”€
      - name: Slack Notify Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "β… *λ°°ν¬ μ„±κ³µ - dddorok-frontend-web* π€\n\n*μ»¤λ°‹ λ©”μ‹μ§€:* \n${{ github.event.head_commit.message }}\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|π”— ν™•μΈν•κΈ°>\n*μ›ν¬ν”λ΅μ°:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|π›  Action ν™•μΈν•κΈ°>\n\n<@U08KFM61DPZ>"
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "π¨ *λ°°ν¬ μ‹¤ν¨ - dddorok-frontend-web* π¨\n\n*μ»¤λ°‹ λ©”μ‹μ§€:* \n${{ github.event.head_commit.message }}\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|π”— ν™•μΈν•κΈ°>\n*μ›ν¬ν”λ΅μ°:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|π›  Action ν™•μΈν•κΈ°>\n\nπ”΄ μ¦‰μ‹ ν™•μΈ λ° μ΅°μΉ μ”λ§! <@U08KFM61DPZ>"
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

# β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ ADMIN β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
  deploy-admin:
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'admin' }}
    runs-on: ubuntu-latest
    concurrency: admin-prod
    env:
      APP_DIR:           ${{ github.workspace }}              # λ™μΌ λ£¨νΈ
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      PROD_ALIAS:        "admin.dddorok.vercel.app"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm@9
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Pull & Build
      - name: Vercel Pull
        run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"

      - name: Vercel Build
        run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          ls -al .vercel/output

      # Deploy
      - name: Vercel Deploy
        id: deploy-admin
        run: |
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "β–¶ Deployed β†’ $DEPLOY_URL"

      # Slack
      - name: Slack Notify Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "β… *λ°°ν¬ μ„±κ³µ - dddorok-frontend-admin* π€\n\n*μ»¤λ°‹ λ©”μ‹μ§€:* \n${{ github.event.head_commit.message }}\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|π”— ν™•μΈν•κΈ°>\n*μ›ν¬ν”λ΅μ°:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|π›  Action ν™•μΈν•κΈ°>\n\n<@U08KFM61DPZ>"
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "π¨ *λ°°ν¬ μ‹¤ν¨ - dddorok-frontend-admin* π¨\n\n*μ»¤λ°‹ λ©”μ‹μ§€:* \n${{ github.event.head_commit.message }}\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|π”— ν™•μΈν•κΈ°>\n*μ›ν¬ν”λ΅μ°:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|π›  Action ν™•μΈν•κΈ°>\n\nπ”΄ μ¦‰μ‹ ν™•μΈ λ° μ΅°μΉ μ”λ§! <@U08KFM61DPZ>"
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
