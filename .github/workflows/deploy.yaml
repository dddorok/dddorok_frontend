name: Deploy Web & Admin to Vercel

on:
  # μλ™ μ‹¤ν–‰
  workflow_dispatch:
    inputs:
      target:
        description: "λ°°ν¬ν•  μ•± μ„ νƒ"
        required: true
        default: "all"
        type: choice
        options: [all, web, admin]

  # development λΈλμΉ μλ™
  push:
    branches: [development]

jobs:
  # β”€β”€β”€β”€β”€β”€β”€β”€β”€ λ³€κ²½ νμΌ ν•„ν„° β”€β”€β”€β”€β”€β”€β”€β”€β”€
  filter:
    if: github.event_name == 'push'          # push μΌ λ•λ§ ν•„μ”
    runs-on: ubuntu-latest
    outputs:
      web:   ${{ steps.paths.outputs.web }}
      admin: ${{ steps.paths.outputs.admin }}
    steps:
      - uses: actions/checkout@v4
      - id: paths
        uses: dorny/paths-filter@v2
        with:
          filters: |
            web:
              - 'apps/web/**'
            admin:
              - 'apps/admin/**'

  # β”€β”€β”€β”€β”€β”€β”€β”€β”€ WEB β”€β”€β”€β”€β”€β”€β”€β”€β”€
  deploy-web:
    needs: [filter]
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'web')) ||
      (github.event_name == 'push' && needs.filter.outputs.web == 'true')
    runs-on: ubuntu-latest
    concurrency: web-prod
    env:
      APP_DIR: ${{ github.workspace }}
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      PROD_ALIAS:        "web.dddorok.vercel.app"

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile

      # Prebuilt κ³Όμ •(λ£¨νΈ κΈ°μ¤€)
      - run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          ls -al .vercel/output

      # Deploy
      - id: deploy
        run: |
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # Slack
      - name: Slack Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "β… *λ°°ν¬ μ„±κ³µ - dddorok-frontend-web* π€" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*μ»¤λ°‹ λ©”μ‹μ§€:*\n" + $msg
                   + "\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|π”— ν™•μΈν•κΈ°>"
                   + "\n*μ›ν¬ν”λ΅μ°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|π›  Action ν™•μΈν•κΈ°>\n\n<@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B || echo '')
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "π¨ *λ°°ν¬ μ‹¤ν¨ - dddorok-frontend-web* π¨" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*μ»¤λ°‹ λ©”μ‹μ§€:*\n" + $msg
                   + "\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|π”— ν™•μΈν•κΈ°>"
                   + "\n*μ›ν¬ν”λ΅μ°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|π›  Action ν™•μΈν•κΈ°>\n\nπ”΄ μ¦‰μ‹ ν™•μΈ λ° μ΅°μΉ μ”λ§! <@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

  # β”€β”€β”€β”€β”€β”€β”€β”€β”€ ADMIN β”€β”€β”€β”€β”€β”€β”€β”€β”€
  deploy-admin:
    needs: [filter]
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'admin')) ||
      (github.event_name == 'push' && needs.filter.outputs.admin == 'true')
    runs-on: ubuntu-latest
    concurrency: admin-prod
    env:
      APP_DIR: ${{ github.workspace }}
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      PROD_ALIAS:        "admin.dddorok.vercel.app"

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile

      - run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          ls -al .vercel/output

      - id: deploy
        run: |
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # Slack(μ„±κ³µ/μ‹¤ν¨ λ™μΌ ν¨ν„΄)
      - name: Slack Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "β… *λ°°ν¬ μ„±κ³µ - dddorok-frontend-admin* π€" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*μ»¤λ°‹ λ©”μ‹μ§€:*\n" + $msg
                   + "\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|π”— ν™•μΈν•κΈ°>"
                   + "\n*μ›ν¬ν”λ΅μ°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|π›  Action ν™•μΈν•κΈ°>\n\n<@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B || echo '')
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "π¨ *λ°°ν¬ μ‹¤ν¨ - dddorok-frontend-admin* π¨" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*μ»¤λ°‹ λ©”μ‹μ§€:*\n" + $msg
                   + "\n\n*μ»¤λ°‹ λ§ν¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|π”— ν™•μΈν•κΈ°>"
                   + "\n*μ›ν¬ν”λ΅μ°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|π›  Action ν™•μΈν•κΈ°>\n\nπ”΄ μ¦‰μ‹ ν™•μΈ λ° μ΅°μΉ μ”λ§! <@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}
      
