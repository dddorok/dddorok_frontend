name: Deploy Web & Admin to Vercel

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      target:
        description: "ë°°í¬í•  ì•± ì„ íƒ"
        required: true
        default: "all"
        type: choice
        options: [all, web, admin]

  # development ë¸Œëœì¹˜ ìë™
  push:
    branches: [development]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë³€ê²½ íŒŒì¼ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë³€ê²½ íŒŒì¼ í•„í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€
  filter:
    runs-on: ubuntu-latest
    outputs:
      web:   ${{ steps.set.outputs.web }}
      admin: ${{ steps.set.outputs.admin }}

    steps:
      - uses: actions/checkout@v4

      # A. push ì´ë²¤íŠ¸ìš©: ë³€ê²½ ê²½ë¡œ ê³„ì‚°
      - id: paths
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v2
        with:
          filters: |
            web:
              - 'apps/web/**'
            admin:
              - 'apps/admin/**'

      # B. ê²°ê³¼ê°’ í†µí•©
      - id: set
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "web=${{ steps.paths.outputs.web }}"   >> "$GITHUB_OUTPUT"
            echo "admin=${{ steps.paths.outputs.admin }}" >> "$GITHUB_OUTPUT"
          else
            # workflow_dispatch â†’ ì‚¬ìš©ìê°€ ê³ ë¥¸ íƒ€ê¹ƒìœ¼ë¡œ ì¶œë ¥ê°’ ê°•ì œ true/false
            case "${{ github.event.inputs.target }}" in
              web)   echo "web=true"  >> "$GITHUB_OUTPUT"; echo "admin=false" >> "$GITHUB_OUTPUT" ;;
              admin) echo "web=false" >> "$GITHUB_OUTPUT"; echo "admin=true"  >> "$GITHUB_OUTPUT" ;;
              all|*) echo "web=true"  >> "$GITHUB_OUTPUT"; echo "admin=true"  >> "$GITHUB_OUTPUT" ;;
            esac
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ WEB â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-web:
    needs: [filter]
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'web')) ||
      (github.event_name == 'push' && needs.filter.outputs.web == 'true')
    runs-on: ubuntu-latest
    concurrency: web-prod
    env:
      APP_DIR: ${{ github.workspace }}
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      PROD_ALIAS:        "web.dddorok.vercel.app"

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile

      # Prebuilt ê³¼ì •(ë£¨íŠ¸ ê¸°ì¤€)
      - run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          ls -al .vercel/output

      # Deploy
      - id: deploy
        run: |
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # Slack
      - name: Slack Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "âœ… *ë°°í¬ ì„±ê³µ - dddorok-frontend-web* ğŸš€" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*ì»¤ë°‹ ë©”ì‹œì§€:*\n" + $msg
                   + "\n\n*ì»¤ë°‹ ë§í¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|ğŸ”— í™•ì¸í•˜ê¸°>"
                   + "\n*ì›Œí¬í”Œë¡œìš°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|ğŸ›  Action í™•ì¸í•˜ê¸°>\n\n<@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B || echo '')
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "ğŸš¨ *ë°°í¬ ì‹¤íŒ¨ - dddorok-frontend-web* ğŸš¨" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*ì»¤ë°‹ ë©”ì‹œì§€:*\n" + $msg
                   + "\n\n*ì»¤ë°‹ ë§í¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|ğŸ”— í™•ì¸í•˜ê¸°>"
                   + "\n*ì›Œí¬í”Œë¡œìš°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|ğŸ›  Action í™•ì¸í•˜ê¸°>\n\nğŸ”´ ì¦‰ì‹œ í™•ì¸ ë° ì¡°ì¹˜ ìš”ë§! <@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-admin:
    needs: [filter]
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'admin')) ||
      (github.event_name == 'push' && needs.filter.outputs.admin == 'true')
    runs-on: ubuntu-latest
    concurrency: admin-prod
    env:
      APP_DIR: ${{ github.workspace }}
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
      PROD_ALIAS:        "admin.dddorok.vercel.app"

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile

      - run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - run: |
          npx vercel build --prod --token="$VERCEL_TOKEN"
          ls -al .vercel/output

      - id: deploy
        run: |
          DEPLOY_URL=$(npx vercel deploy . --prebuilt --prod --yes --token="$VERCEL_TOKEN" | tail -1)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # Slack(ì„±ê³µ/ì‹¤íŒ¨ ë™ì¼ íŒ¨í„´)
      - name: Slack Notify Success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "âœ… *ë°°í¬ ì„±ê³µ - dddorok-frontend-admin* ğŸš€" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*ì»¤ë°‹ ë©”ì‹œì§€:*\n" + $msg
                   + "\n\n*ì»¤ë°‹ ë§í¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|ğŸ”— í™•ì¸í•˜ê¸°>"
                   + "\n*ì›Œí¬í”Œë¡œìš°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|ğŸ›  Action í™•ì¸í•˜ê¸°>\n\n<@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack Notify Failure
        if: failure()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B || echo '')
          curl -X POST -H 'Content-type: application/json' \
               --data "$(jq -n \
                 --arg t   "ğŸš¨ *ë°°í¬ ì‹¤íŒ¨ - dddorok-frontend-admin* ğŸš¨" \
                 --arg msg "${{ github.event.head_commit.message }}" \
                 --arg repo "${{ github.repository }}" \
                 --arg sha  "${{ github.sha }}" \
                 --arg run  "${{ github.run_id }}" \
                 '{text: ($t + "\n\n*ì»¤ë°‹ ë©”ì‹œì§€:*\n" + $msg
                   + "\n\n*ì»¤ë°‹ ë§í¬:* <https://github.com/" + $repo + "/commit/" + $sha + "|ğŸ”— í™•ì¸í•˜ê¸°>"
                   + "\n*ì›Œí¬í”Œë¡œìš°:* <https://github.com/" + $repo + "/actions/runs/" + $run + "|ğŸ›  Action í™•ì¸í•˜ê¸°>\n\nğŸ”´ ì¦‰ì‹œ í™•ì¸ ë° ì¡°ì¹˜ ìš”ë§! <@U08KFMBSXB9>")}')" \
               ${{ secrets.SLACK_WEBHOOK_URL }}
      
